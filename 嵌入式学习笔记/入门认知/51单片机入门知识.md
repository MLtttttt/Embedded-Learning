
## **一、核心架构
**

### **1.1 基本架构图**
```
╔══════════════════════════════════════════════════════════════════╗
║                    51单片机CPU内部结构简图                          ║
╠══════════════════════════════════════════════════════════════════╣
║                                                                  ║
║  ┌──────────────────────────────────────────────────────────┐    ║
║  │                    控制单元(CPU大脑)                       │    ║
║  │  ┌────────────┐  ┌────────────┐  ┌─────────────┐         │    ║
║  │  │ 指令寄存器IR│  │ 指令译码器 │  │ 时序控制电路 │            │    ║
║  │  │   (8位)    │  │            │  │             │         │    ║
║  │  └─────┬──────┘  └─────┬──────┘  └──────┬──────┘         │    ║
║  │        │                │                │               │    ║
║  └────────┼────────────────┼────────────────┼───────────────┘    ║
║           │                │                │                    ║
║  ┌────────▼────────────────▼────────────────▼───────────────┐    ║
║  │             运算器(ALU) - CPU的"双手"                      │    ║
║  │     ┌──────────────────────────────────────┐             │    ║
║  │     │  加法器 + 逻辑运算器 + 移位器        │                │    ║
║  │     └──────────────────────────────────────┘             │    ║
║  │        输入：ACC、B寄存器、暂存器                           │    ║
║  │        输出：ACC、PSW标志位                                │    ║
║  └─────────────┬──────────────────────────────┬───────────-─┘    ║
║                │                              │                  ║
║  ┌─────────────▼──────────────┐ ┌────────────▼──────────────┐    ║
║  │     核心寄存器组           │ │    程序计数器PC           │       ║
║  │  ┌─────┬─────┬─────┐    │ │ │     (16位)               │      ║
║  │  │ ACC │  B  │ PSW │    │ │ │   指向下条指令地址        │       ║
║  │  ├─────┼─────┼─────┤    │ │ └──────────────────────────┘      ║
║  │  │ SP  │DPTR │R0-R7│    │ │                                   ║
║  │  └─────┴─────┴─────┘    │ │ ┌──────────────────────────┐      ║
║  │     控制：               │ │ │     内部总线              │      ║
║  │     - 运算(ACC,B)       │ │ │  ┌──┬──┬──┬──┬──┐        │       ║
║  │     - 状态(PSW)         │ │ │  │D7│D6│...│D1│D0│       │       ║
║  │     - 地址(DPTR)        │ │ │  └──┴──┴──┴──┴──┘        │       ║
║  │     - 堆栈(SP)          │ │ │      (8位数据总线)         │      ║
║  └─────────────────────────┘ │ └──────────┬───────────────┘      ║
║                               │            │                     ║
║  ┌────────────────────────────▼────────────▼───────────────┐     ║
║  │                    地址总线(16位)                       │      ║
║  │            ┌────┬────┬────┬────┬────┬────┐            │       ║
║  │            │A15│A14│...│A1 │A0 │    │    │            │       ║
║  │            └────┴────┴────┴────┴────┴────┘            │       ║
║  │                 来源：PC或DPTR                         │       ║
║  └───────────────────────────────────────────────────────┘       ║
║                                                                  ║
║  ┌──────────────────────────────────────────────────────────┐   ║
║  │                   存储器与I/O接口                          │    ║
║  │  ┌────────────┐  ┌────────────┐  ┌─────────────┐         │    ║
║  │  │   ROM接口  │  │   RAM接口  │  │   I/O接口   │          │      ║
║  │  │  (程序)    │  │  (数据)    │  │  (P0-P3)    │        │       ║
║  │  └────────────┘  └────────────┘  └─────────────┘         │    ║
║  └──────────────────────────────────────────────────────────┘   ║
║                                                                  ║
║  ┌──────────────────────────────────────────────────────────┐   ║
║  │                    中断控制系统                          │   ║
║  │  ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐                │   ║
║  │  │INT0 │ │INT1 │ │ T0  │ │ T1  │ │串口 │                │   ║
║  │  └─────┘ └─────┘ └─────┘ └─────┘ └─────┘                │   ║
║  │      │       │       │       │       │                   │   ║
║  │  ┌───▼───────▼───────▼───────▼───────▼─────┐           │   ║
║  │  │           中断优先级仲裁电路             │           │   ║
	║  │  └─────────────────────────────────────────┘           │   ║ 
║  └──────────────────────────────────────────────────────────┘   ║
║                                                                  ║
║  ┌──────────────────────────────────────────────────────────┐   ║
║  │                    时钟与复位系统                        │   ║
║  │  ┌────────────┐  ┌────────────┐  ┌─────────────┐      │   ║
║  │  │  晶振电路  │  │  时钟分频  │  │  复位电路   │      │   ║
║  │  │  (12MHz)   │  │   (÷12)    │  │  (RST引脚)  │      │   ║
║  │  └────────────┘  └────────────┘  └─────────────┘      │   ║
║  └──────────────────────────────────────────────────────────┘   ║
╚══════════════════════════════════════════════════════════════════╝                     
```

### **1.2 工作原理简化**
```
上电 → 复位 → 时钟起振 → 取指令 → 译码 → 执行 → 循环
```

### **1.3 引脚与寄存器关系**
```
软件 → 寄存器 → 硬件电路 → 引脚 → 外部世界
   ↓       ↓         ↓         ↓         ↓
 想法  控制面板    转换器    执行器    实际效果
```


## **二、引脚定义
### **2.1 引脚总览图**
```
        ┌──────────────────────┐
   P1.0 │1                   40│ VCC (+5V)     ← 电源正极
   P1.1 │2                   39│ P0.0/AD0
   P1.2 │3                   38│ P0.1/AD1
   P1.3 │4                   37│ P0.2/AD2
   P1.4 │5    51单片机       36│ P0.3/AD3
   P1.5 │6   (AT89C51等)     35│ P0.4/AD4
   P1.6 │7                   34│ P0.5/AD5
   P1.7 │8                   33│ P0.6/AD6
   RST  │9（恢复初始状态）     32│ P0.7/AD7
  RXD/P3.0│10                31│ EA/VPP       ← 程序选择
  TXD/P3.1│11                30│ ALE/PROG     ← 地址锁存
INT0/P3.2│12                29│ PSEN          ← 程序使能
INT1/P3.3│13                28│ P2.7/A15
  T0/P3.4│14                27│ P2.6/A14
  T1/P3.5│15                26│ P2.5/A13
  WR/P3.6│16                25│ P2.4/A12
  RD/P3.7│17                24│ P2.3/A11
  XTAL2 │18（晶振振荡电路输入端）23│ P2.2/A10
  XTAL1 │19（晶振振荡电路输出端）22│ P2.1/A9
   GND   │20← 电源负极（接地）  21│ P2.0/A8
        └──────────────────────┘
```

### **2.2 P0-P3口详细对比表**

| 特性       | P0口                                             | P1口      | P2口                            | P3口                     |
| -------- | ----------------------------------------------- | -------- | ------------------------------ | ----------------------- |
| **引脚号**  | 32-39                                           | 1-8      | 21-28                          | 10-17                   |
| **地址**   | 0x80                                            | 0x90     | 0xA0                           | 0xB0                    |
| **驱动方式** | 开漏输出                                            | 准双向      | 准双向                            | 准双向                     |
| **上拉电阻** | 需要外部                                            | 内部有      | 内部有                            | 内部有                     |
| **主要功能** | 1. 普通I/O<br>2. 数据总线(D0-D7)<br>3. 地址总线低8位(A0-A7) | 普通I/O    | 1. 普通I/O<br>2. 地址总线高8位(A8-A15) | 1. 普通I/O<br>2. 第二功能（重要） |
| **特殊注意** | 必须接上拉电阻(4.7K-10K)                               | 最简单，新手首选 | 访问外部存储器时用作地址高8位                | 第二功能优先                  |

### **2.3 P3口第二功能（必须记住！）**

```
P3.0 (10脚)：RXD    - 串行数据接收
P3.1 (11脚)：TXD    - 串行数据发送
P3.2 (12脚)：INT0   - 外部中断0
P3.3 (13脚)：INT1   - 外部中断1
P3.4 (14脚)：T0     - 定时器0外部输入
P3.5 (15脚)：T1     - 定时器1外部输入
P3.6 (16脚)：WR     - 外部数据存储器写信号
P3.7 (17脚)：RD     - 外部数据存储器读信号
```



## **三、寄存器分类与功能概览**

### **3.1 寄存器全景图**
```
┌─────────────────────────────────────────────────────────────┐
│                    特殊功能寄存器(SFR)                       │
├─────────────────────────────────────────────────────────────┤
│ 运算类 │ 指针类 │ I/O控制 │ 中断类 │ 定时器 │ 串口 │ 其他 │
├─────────┼───────┼─────────┼───────┼───────┼─────┼─────┤
│ ACC     │ SP    │ P0-P3   │ IE    │ TCON  │ SCON│ PCON│
│ B       │ DPTR  │         │ IP    │ TMOD  │ SBUF│     │
│ PSW     │       │         │       │ TH0/TL0│    │     │
│         │       │         │       │ TH1/TL1│    │     │
└─────────┴───────┴─────────┴───────┴───────┴─────┴─────┘
```

### **3.2 运算相关寄存器**

| 寄存器 | 地址 | 功能 | 详细说明 | 应用场景 |
|--------|------|------|----------|----------|
| **ACC** | 0xE0 | 累加器 | 所有算术/逻辑运算必须经过ACC | `a = b + c;` |
| **B** | 0xF0 | B寄存器 | 乘除法辅助寄存器，乘：存高位；除：存余数 | `c = a * b;` |
| **PSW** | 0xD0 | 程序状态字 | 记录CPU运算状态，含8个标志位 | 判断运算结果 |

### **3.3 指针类寄存器**

| 寄存器 | 地址 | 功能 | 详细说明 | 复位值 |
|--------|------|------|----------|---------|
| **SP** | 0x81 | 堆栈指针 | 指向堆栈顶部地址，用于函数调用和中断 | 0x07 |
| **DPTR** | 0x82-83 | 数据指针 | 16位地址指针，DPH(高8位)+DPL(低8位) | 0x0000 |

### **3.4 I/O端口寄存器**

| 寄存器 | 地址 | 控制引脚 | 工作模式 | 特殊说明 |
|--------|------|----------|----------|----------|
| **P0** | 0x80 | P0.0-P0.7 | 开漏输出 | 作总线或I/O，需外接上拉电阻 |
| **P1** | 0x90 | P1.0-P1.7 | 准双向口 | 最简单I/O，无第二功能 |
| **P2** | 0xA0 | P2.0-P2.7 | 准双向口 | 可作地址高8位 |
| **P3** | 0xB0 | P3.0-P3.7 | 准双向口 | 有第二功能，优先使用 |

### **3.5 中断控制寄存器**

| 寄存器 | 地址 | 功能 | 位定义 | 常用设置 |
|--------|------|------|--------|----------|
| **IE** | 0xA8 | 中断允许 | EA(总), ES(串口), ET1/ET0(定时), EX1/EX0(外部) | 0x82(开串口中断) |
| **IP** | 0xB8 | 中断优先级 | PS, PT1/PT0, PX1/PX0 | 0x10(串口高优先级) |

### **3.6 定时器/计数器寄存器**

| 寄存器         | 地址        | 功能    | 位定义/用法                             |
| ----------- | --------- | ----- | ---------------------------------- |
| **TCON**    | 0x88      | 控制寄存器 | TF1/TR1, TF0/TR0, IE1/IT1, IE0/IT0 |
| **TMOD**    | 0x89      | 模式寄存器 | GATE, C/T, M1, M0 (定时器1和0各4位)      |
| **TH0/TL0** | 0x8C/0x8A | 定时器0  | 16位计数初值                            |
| **TH1/TL1** | 0x8D/0x8B | 定时器1  | 16位计数初值                            |
|             |           |       |                                    |

### **3.7 串口通信寄存器**

| 寄存器 | 地址 | 功能 | 位定义 | 常用模式 |
|--------|------|------|--------|----------|
| **SCON** | 0x98 | 控制寄存器 | SM0/SM1(模式), REN(接收允许), TI/RI(标志) | 0x50(模式1) |
| **SBUF** | 0x99 | 数据缓冲 | 发送/接收数据缓冲器 | 读写自动区分 |

### **3.8 PSW位结构图**
```
位号  位名    功能说明
D7 ── CY  ── 进位/借位标志（有进位/借位时置1）
D6 ── AC  ── 辅助进位标志（低4位向高4位进位时置1）
D5 ── F0  ── 用户标志位（用户自定义使用）
D4 ── RS1 ── 寄存器组选择位1
D3 ── RS0 ── 寄存器组选择位0
D2 ── OV  ── 溢出标志（有符号数运算溢出时置1）
D1 ──     ── 保留位
D0 ── P   ── 奇偶标志（ACC中1的个数为奇数时置1）
```

### **3.9 寄存器组选择**
```
RS1 RS0 选择寄存器组  地址范围    用途
 0   0      组0      00H-07H    默认组
 0   1      组1      08H-0FH    中断服务常用
 1   0      组2      10H-17H    多级嵌套中断
 1   1      组3      18H-1FH    特殊应用
```

## **四、寄存器协同工作流程**

### **4.1 数据运算流程**
```
        ┌─────────┐
输入数据 → │   ACC   │ ← 运算中心（所有运算在此进行）
        └────┬────┘
             ↓ 运算结果影响
        ┌─────────┐
        │   PSW   │ ← 自动更新状态标志
        └────┬────┘
             ↓ 需要存储时
        ┌─────────┐
        │   DPTR  │ ← 导航到存储位置
        └────┬────┘
             ↓ 通过地址存储
        ┌─────────┐
        │  RAM/ROM │ ← 实际存储位置
        └─────────┘
```

### **4.2 函数调用流程（SP作用）**
```
主函数调用func()时：
1. 返回地址压入堆栈 → SP+2
2. 局部变量入栈 → SP+1
3. 执行func()代码
4. 局部变量出栈 → SP-1
5. 返回地址出栈 → SP-2
6. 返回主函数继续执行
```

## **五、寄存器初始化规范**

### **5.1 标准初始化函数**
```c
/**
 * 系统初始化函数
 * 说明：上电后必须执行的基本初始化
 */
void System_Init(void)
{
    // 1. I/O端口初始化（设为输入模式）
    P0 = 0xFF;  // P0口设为输入（先写1）
    P1 = 0xFF;  // P1口设为输入
    P2 = 0xFF;  // P2口设为输入  
    P3 = 0xFF;  // P3口设为输入
    
    // 2. 堆栈指针初始化（避免堆栈溢出）
    SP = 0x60;  // 指向RAM高地址区（默认07H太低）
    
    // 3. 定时器初始化
    TMOD = 0x21;  // 定时器1:方式2(自动重装)，定时器0:方式1(16位)
    TH1 = 0xFD;   // 波特率9600@11.0592MHz
    TL1 = 0xFD;
    TR1 = 1;      // 启动定时器1
    
    // 4. 串口初始化
    SCON = 0x50;  // 串口方式1，允许接收
    PCON = 0x00;  // 波特率不倍增
    ES = 1;       // 允许串口中断
    
    // 5. 中断系统初始化
    EA = 1;       // 开总中断
    // 其他中断根据需求设置
}
```

### **5.2 重要初始化原则**

| 原则 | 原因 | 示例 |
|------|------|------|
| **先设方向后读写** | 51的I/O口读取前需先设为输入 | `P1=0xFF;`后再`val=P1;` |
| **堆栈设在高位** | 避免堆栈与变量区冲突 | `SP=0x60;`而非默认0x07 |
| **定时器先设模式后启动** | 保证计数模式正确 | 先`TMOD=0x01;`后`TR0=1;` |
| **中断最后开启** | 避免未初始化完成就中断 | 其他设完后再`EA=1;` |

## **六、关键寄存器使用示例**

### **6.1 ACC运算示例**
```c
// 计算 y = a*x + b
unsigned char calculate(unsigned char a, unsigned char x, unsigned char b)
{
    unsigned char y;
    
    // 编译器自动使用ACC
    y = a * x;  // 乘法：a放ACC，x放B，结果在ACC和B
    y = y + b;  // 加法：在ACC中进行
    
    return y;   // 结果从ACC返回
}
```

### **6.2 DPTR查表示例**
```c
// 数码管显示编码表（位于程序存储器）
code unsigned char seg_table[] = {
    0x3F,  // 0
    0x06,  // 1
    0x5B,  // 2
    0x4F,  // 3
    0x66,  // 4
    0x6D,  // 5
    0x7D,  // 6
    0x07,  // 7
    0x7F,  // 8
    0x6F   // 9
};

// 查表获取数码管编码
unsigned char get_seg_code(unsigned char num)
{
    if(num > 9) num = 0;  // 范围检查
    
    // 使用DPTR查表（编译器自动生成）
    return seg_table[num];
}
```

### **6.3 PSW状态判断**
```c
// 检测加法是否溢出
unsigned char add_with_check(unsigned char a, unsigned char b)
{
    unsigned char result;
    unsigned char status;
    
    result = a + b;          // 执行加法
    status = PSW;            // 读取PSW状态
    
    if(status & 0x80)        // 检查CY位(D7)
    {
        // 有进位（无符号数溢出）
        // 处理溢出情况
    }
    
    if(status & 0x04)        // 检查OV位(D2)
    {
        // 有溢出（有符号数溢出）
        // 处理溢出情况
    }
    
    return result;
}
```

## **七、寄存器快速查询表**

### **按地址排序**
```
0x80: P0     0x90: P1     0xA0: P2     0xB0: P3
0x81: SP     0x88: TCON   0x89: TMOD   0x8A: TL0
0x8B: TL1    0x8C: TH0    0x8D: TH1    0x98: SCON
0x99: SBUF   0xA8: IE     0xB8: IP     0xD0: PSW
0xE0: ACC    0xF0: B
```

### **按功能排序**
```
运算：ACC(0xE0), B(0xF0), PSW(0xD0)
指针：SP(0x81), DPTR(0x82-83)
I/O：P0(0x80), P1(0x90), P2(0xA0), P3(0xB0)
中断：IE(0xA8), IP(0xB8)
定时器：TCON(0x88), TMOD(0x89), TH0/TL0(0x8C/0x8A), TH1/TL1(0x8D/0x8B)
串口：SCON(0x98), SBUF(0x99)
```



## **八、常用代码片段**

### **8.1 位操作宏定义**
```c
// 定义单个引脚
sbit LED = P1^0;      // P1.0控制LED
sbit KEY = P1^1;      // P1.1连接按键
sbit BUZZER = P2^3;   // P2.3控制蜂鸣器

// 使用
LED = 0;              // 点亮LED（低电平有效）
if(KEY == 0) {        // 检测按键按下
    BUZZER = 1;       // 蜂鸣器响
}
```

### **8.2 简单延时函数**
```c
void delay_ms(unsigned int ms) {
    unsigned int i, j;
    for(i = 0; i < ms; i++)
        for(j = 0; j < 120; j++);  // 12MHz下的近似值
}
```

### **8.3 流水灯示例**
```c
#include <reg51.h>
#include <intrins.h>  // 包含_crol_函数

void main() {
    unsigned char pattern = 0xFE;  // 11111110
    
    while(1) {
        P1 = pattern;              // 输出到P1口
        delay_ms(200);             // 延时200ms
        pattern = _crol_(pattern, 1);  // 循环左移
    }
}
```

---
